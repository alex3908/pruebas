<% if @quotation.have_capital_payment %>
  <style>
  .payments-quotation th, .payments-quotation td { font-size: 10px; }
  </style>
<% end %>
<% @folder.clients.each do |client| %>
  <%= render partial: "folders/files/partials/amortization_cover_for_pdf", locals: { name: "TABLA DE AMORTIZACIÓN",
                                                                                    representative_name: nil,
                                                                                    representative_email: nil,
                                                                                    representative_sign_tag: nil,
                                                                                    user_name: @folder.user.label,
                                                                                    user_email: @folder.user.email,
                                                                                    clients:[client],
                                                                                    clients_count: 1,
                                                                                    date: Time.zone.now.strftime("%Y/%m/%d"),
                                                                                    folio: @folder.id,
                                                                                    total_payments: @folder.payment_scheme.total_payments,
                                                                                    project_name: @project.name,
                                                                                    stage_name: @stage.full_name("/"),
                                                                                    lot_reference: @folder.lot.reference,
                                                                                    lot_name: @folder.lot.name,
                                                                                    lot_area: @folder.lot.area,
                                                                                    show_price: @stage.show_price,
                                                                                    total_with_discount: @folder.total_sale,
                                                                                    initial_payment: @folder.payment_scheme.initial_payment,
                                                                                    down_payment: @folder.payment_scheme.down_payment,
                                                                                    lock_payment: @folder.payment_scheme.lock_payment,
                                                                                    complement_payment: @folder.payment_scheme.complement_payment,
                                                                                    down_payment_finance: @folder.payment_scheme.down_payment_finance,
                                                                                    down_payment_monthly_payments: @folder.first_down_payment&.total,
                                                                                    down_payment_percentage: @quotation.down_payment_percentage,
                                                                                    min_down_payment: @quotation.total_with_discount * @stage.credit_scheme.get_min_down_payment(0.01),
                                                                                    first_down_payment: @folder.first_down_payment&.date&.strftime("%d-%m-%Y"),
                                                                                    first_finance: @folder.first_financing&.date&.strftime("%d-%m-%Y"),
                                                                                    show_rate: @stage.show_rate,
                                                                                    interest_payments: @quotation.interest_payments,
                                                                                    bank_accounts: @stage.enterprise.bank_accounts,
                                                                                    stp_clabe: @folder.stp_clabe,
                                                                                    enterprise_name: @folder.stage.enterprise.business_name,
                                                                                    project_singular: @project_singular,
                                                                                    lot_singular: @lot_singular,
                                                                                    price: @quotation.price,
                                                                                    total_discount: @quotation.total_discount,
                                                                                    valid_for_folder: true,
                                                                                    with_signature: @with_signature,
                                                                                    show_payment_dates: @project.show_payment_dates,
                                                                                    has_custom_installments: @folder.has_custom_installments?
  } %>

<% end %>

<% @folder.ruled_contract.signers.each_with_index do |signer, index| %>
  <%= render partial: "folders/files/partials/amortization_cover_for_pdf", locals: { name: "TABLA DE AMORTIZACIÓN",
                                                                                    representative_name: signer.label,
                                                                                    representative_email: signer.email,
                                                                                    representative_sign_tag: signer.sign_tag,
                                                                                    user_name: nil,
                                                                                    user_email: nil,
                                                                                    clients:[],
                                                                                    clients_count: 0,
                                                                                    date: Time.zone.now.strftime("%Y/%m/%d"),
                                                                                    folio: @folder.id,
                                                                                    total_payments: @folder.payment_scheme.total_payments,
                                                                                    project_name: @project.name,
                                                                                    stage_name: @stage.full_name("/"),
                                                                                    lot_reference: @folder.lot.reference,
                                                                                    lot_name: @folder.lot.name,
                                                                                    lot_area: @folder.lot.area,
                                                                                    show_price: @stage.show_price,
                                                                                    total_with_discount: @folder.total_sale,
                                                                                    initial_payment: @folder.payment_scheme.initial_payment,
                                                                                    down_payment: @folder.payment_scheme.down_payment,
                                                                                    lock_payment: @folder.payment_scheme.lock_payment,
                                                                                    complement_payment: @folder.payment_scheme.complement_payment,
                                                                                    down_payment_finance: @folder.payment_scheme.down_payment_finance,
                                                                                    down_payment_monthly_payments: @folder.first_down_payment&.total,
                                                                                    down_payment_percentage: @quotation.down_payment_percentage,
                                                                                    min_down_payment: @quotation.total_with_discount * @stage.credit_scheme.get_min_down_payment(0.01),
                                                                                    first_down_payment: @folder.first_down_payment&.date&.strftime("%d-%m-%Y"),
                                                                                    first_finance: @folder.first_financing&.date&.strftime("%d-%m-%Y"),
                                                                                    show_rate: @stage.show_rate,
                                                                                    interest_payments: @quotation.interest_payments,
                                                                                    bank_accounts: @stage.enterprise.bank_accounts,
                                                                                    stp_clabe: @folder.stp_clabe,
                                                                                    enterprise_name: @folder.stage.enterprise.business_name,
                                                                                    project_singular: @project_singular,
                                                                                    lot_singular: @lot_singular,
                                                                                    price: @quotation.price,
                                                                                    total_discount: @quotation.total_discount,
                                                                                    valid_for_folder: true,
                                                                                    with_signature: @with_signature,
                                                                                    show_payment_dates: @project.show_payment_dates,
                                                                                    has_custom_installments: @folder.has_custom_installments?
  } %>

<% end if @is_digital_signature %>

<%= render partial: @smaller_amortization ? "folders/files/partials/amortization_table_squashed_for_pdf" : "folders/files/partials/amortization_table_for_pdf",
                                                                locals: {
                                                                   valid_for_folder: true,
                                                                   amr: @amr,
                                                                   have_capital_payment: @quotation.have_capital_payment,
                                                                   down_payment_monthly_payments: @down_payment_installments,
                                                                   capital_total: @capital_total,
                                                                   interest_total: @interest_total,
                                                                   down_payment_total: @down_payment_total,
                                                                   payment_total: @payment_total,
                                                                   capital_payments_total: @capital_payments_total,
                                                                   show_interest: @folder.show_interest
} %>
